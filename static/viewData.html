<!doctype html>
<html dir="ltr" lang="en" class="h-full bg-gray-100">

<head>
    <meta charset="utf-8">
    <title>Mushroom Datalogger - Data Viewer</title>
    <style>

    </style>
    <link href="/static/?path=output.css" rel="stylesheet">

    <!-- Only for quick local testing -->
    <link href="./output.css" rel="stylesheet">
</head>

<body class="h-full">
    <!--
    This example requires updating your template:

    ```
    <html class="h-full bg-gray-100">
    <body class="h-full">
    ```
    -->
    <div class="min-h-full">
        <nav class="bg-gray-800">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <img class="h-8 w-8" src="https://tailwindui.com/img/logos/mark.svg?color=indigo&shade=500"
                                alt="Your Company">
                        </div>

                    </div>
                </div>
            </div>
        </nav>

        <header class="bg-white shadow">
            <div class="mx-auto max-w-7xl py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Mushroom Datalogger - Data Viewer</h1>
                <h2 id="dateTitle"></h2>
            </div>
        </header>
        <main>
            <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
                <!-- Replace with your content -->
                <div class="overflow-hidden bg-white shadow sm:rounded-lg my-6">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Humidity</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">0-100%</p>
                    </div>
                    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                        <dl class="sm:divide-y sm:divide-gray-200">
                            <div class="py-4 sm:grid sm:grid-cols-4 sm:gap-4 sm:py-5 sm:px-6">
                                <canvas id="humidityChart" width="800" height="300"></canvas>
                            </div>
                        </dl>
                    </div>
                </div>

                <div class="overflow-hidden bg-white shadow sm:rounded-lg my-6">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Temperature</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">(In Celsius)</p>
                    </div>
                    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                        <dl class="sm:divide-y sm:divide-gray-200">
                            <div class="py-4 sm:grid sm:grid-cols-4 sm:gap-4 sm:py-5 sm:px-6">
                                <canvas id="temperatureChart" width="800" height="300"></canvas>
                            </div>
                        </dl>
                    </div>
                </div>

                <div class="overflow-hidden bg-white shadow sm:rounded-lg my-6">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">CO2:</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">In parts per million (ppm) - normal is less than 900</p>
                    </div>
                    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                        <dl class="sm:divide-y sm:divide-gray-200">
                            <div class="py-4 sm:grid sm:grid-cols-4 sm:gap-4 sm:py-5 sm:px-6">
                                <canvas id="CO2Chart" width="800" height="300"></canvas>
                            </div>
                        </dl>
                    </div>
                </div>

                <div class="overflow-hidden bg-white shadow sm:rounded-lg my-6">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Gas Resistance:</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">50-50000 ohms</p>
                    </div>
                    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                        <dl class="sm:divide-y sm:divide-gray-200">
                            <div class="py-4 sm:grid sm:grid-cols-4 sm:gap-4 sm:py-5 sm:px-6">
                                <canvas id="GasChart" width="800" height="300"></canvas>
                            </div>
                        </dl>
                    </div>
                </div>

                <div class="overflow-hidden bg-white shadow sm:rounded-lg my-6">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">eCO2:</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">In parts per million (ppm) - normal is less than 900</p>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">eC02 is approximated from gas levels</p>
                    </div>
                    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                        <dl class="sm:divide-y sm:divide-gray-200">
                            <div class="py-4 sm:grid sm:grid-cols-4 sm:gap-4 sm:py-5 sm:px-6">
                                <canvas id="eCO2Chart" width="800" height="300"></canvas>
                            </div>
                        </dl>
                    </div>
                </div>

                <div class="overflow-hidden bg-white shadow sm:rounded-lg my-6">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Pressure:</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">1013.25 hPa (hectopascal) is normal sea level pressure</p>
                    </div>
                    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                        <dl class="sm:divide-y sm:divide-gray-200">
                            <div class="py-4 sm:grid sm:grid-cols-4 sm:gap-4 sm:py-5 sm:px-6">
                                <canvas id="pressureChart" width="800" height="300"></canvas>
                            </div>
                        </dl>
                    </div>
                </div>

                <div class="overflow-hidden bg-white shadow sm:rounded-lg my-6">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">TVOC:</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Total Volatile Organic Compounds</p>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Parts Per Billion (ppb)</p>
                    </div>
                    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                        <dl class="sm:divide-y sm:divide-gray-200">
                            <div class="py-4 sm:grid sm:grid-cols-4 sm:gap-4 sm:py-5 sm:px-6">
                                <canvas id="TVOCChart" width="800" height="300"></canvas>
                            </div>
                        </dl>
                    </div>
                </div>

                <div class="overflow-hidden bg-white shadow sm:rounded-lg my-6">
                    <div class="px-4 py-5 sm:px-6">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Luminosity:</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Lux</p>
                    </div>
                    <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                        <dl class="sm:divide-y sm:divide-gray-200">
                            <div class="py-4 sm:grid sm:grid-cols-4 sm:gap-4 sm:py-5 sm:px-6">
                                <canvas id="luxChart" width="800" height="300"></canvas>
                            </div>
                        </dl>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- <script src="/static/?path=chart.min.js"></script>
    <script src="/static/?path=tailwindcss_3.2.4.min.js"></script> -->
    
    
    <!-- Only for quick local testing -->
    <script src="./chart.min.js"></script>
    <script>

        // Util functions

        function getFullReadableDateLabel(ts) {
            var newDate = new Date();
            newDate.setTime(ts * 1000);
            dateString = newDate.toUTCString();
            return dateString;
        }

        function getChartDateLabel(ts) {
            var newDate = new Date();
            newDate.setTime(ts * 1000);
            dateString = newDate.toLocaleTimeString('en-US');
            return dateString;
        }

        (async () => {
            try {
                console.log("Starting JS")
                let fetchConfigLocation = '';
                let fetchDataLocation = '';
                if (window.location.href.includes("0.0.0.0")) {
                    console.log("LOCAL MODE")
                    // we're working locally
                    fetchDataLocation = '../test/data.jsonlines';
                    fetchConfigLocation = '../config.json'
                } else {
                    fetchDataLocation = '/rawdata/';
                    fetchConfigLocation = '/config/';
                }
                const mode = {};
                //retrieve config data...
                const systemConfig = await fetch(fetchConfigLocation, mode).then((data) => data.text()).then(data => { return data });
                console.log(systemConfig);

                const rawData = await fetch(fetchDataLocation, mode).then((data) => data.text()).then(data => { return data });
                let splitData = rawData.split("\n");
                // To simplify label formatting, only show 100 data points
                // splitData = splitData.slice(0,100);
                console.log(`Data lines: ${splitData.length}`)
                let lastTimeStamp = 0;
                const parsedData = splitData.reduce((results, item) => {
                    if (!item || item == undefined || item == ''){
                        return results
                    }
                    let dataObj = JSON.parse(item);
                    // assume timestamps are ascending
                    // filter out data with weird, past rtc times
                    // if (lastTimeStamp < dataObj["time_rtc"]) {
                        lastTimeStamp = dataObj["time_rtc"]
                        results.push(dataObj)
                        return results
                    // }
                    console.log(`Skipping data with rtc time: ${dataObj["time_rtc"]}`)
                    return results
                }, [])
                console.log(parsedData);
                
                // To simplify charts, show start and end day/month/year at top
                const labels = parsedData.map(sensorData => getFullReadableDateLabel(sensorData["time_rtc"]));
                const fullLabels = parsedData.map(sensorData => getFullReadableDateLabel(sensorData["time_rtc"]));

                const dateTitleEl = document.getElementById("dateTitle");
                const dateRangeString = `Date Range: ${fullLabels[0]} - ${fullLabels[fullLabels.length - 1]}`
                dateTitleEl.innerHTML = dateRangeString;

                // Humidty
                const humidityAHT20Data = parsedData.map(sensorData => sensorData["humidity_aht20"]);
                const humiditySCD4xData = parsedData.map(sensorData => sensorData["humidity_SCD40"]);
                const humidityBME688Data = parsedData.map(sensorData => sensorData["humidity_bme688"]); 
                
                timeTick = {
                    // For a category axis, the val is the index so the lookup via getLabelForValue is needed
                    callback: function (val, index) {
                        // Hide some labels for simplicity
                        return index % 4 === 0 ? this.getLabelForValue(val) : '';
                    },
                    // color: 'red',
                    align: 'center',
                }

                var ctx = document.getElementById('humidityChart');
                var ctx2d = ctx.getContext("2d");
                var data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'AHT20 Humidity',
                            data: humidityAHT20Data,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'SCD40 Humidity',
                            data: humiditySCD4xData,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'BME688 Humidity',
                            data: humidityBME688Data,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }
                    ]
                };
                var options = {
                    responsive: true,
                    plugins:{
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: timeTick
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Relative Humidty'
                            },
                            // min: 0,
                            // max: 100,
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + "%";
                                },
                                stepSize: 1
                            }
                        }
                    }
                }
                var config = {
                    type: 'line',
                    data: data,
                    options: options,
                };
                var humidityChart = new Chart(ctx, config);

                // Temperature
                const tempBMP280Data = parsedData.map(sensorData => sensorData["temperature_bmp280"]);
                const tempAHT20Data = parsedData.map(sensorData => sensorData["temperature_aht20"]);
                const tempSCD4xData = parsedData.map(sensorData => sensorData["temperature_SCD40"]);
                const tempBME688Data = parsedData.map(sensorData => sensorData["temperature_bme688"]);

                ctx = document.getElementById('temperatureChart');
                ctx2d = ctx.getContext("2d");
                data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'BMP280 Temperature',
                            data: tempBMP280Data,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'AHT20 Temperature',
                            data: tempAHT20Data,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'SCD40 Temperature',
                            data: tempSCD4xData,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'BME688 Temperature',
                            data: tempBME688Data,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }
                    ]
                };
                options = {
                    responsive: true,
                    plugins:{
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: timeTick
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature'
                            },
                            // min: 10,
                            // max: 45,
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + "C";
                                },
                                stepSize: 2
                            }
                        }
                    }
                }
                config = {
                    type: 'line',
                    data: data,
                    options: options,
                };
                const temperatureChart= new Chart(ctx, config);

                // Pressure
                const pressureBMP280Data = parsedData.map(sensorData => sensorData["pressure_bmp280"] / 100);
                const pressureBME688Data = parsedData.map(sensorData => sensorData["pressure_bme688"] / 100);

                ctx = document.getElementById('pressureChart');
                ctx2d = ctx.getContext("2d");
                data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'BMP280 Pressure',
                            data: pressureBMP280Data,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'BME688 Pressure',
                            data: pressureBME688Data,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }                        
                    ]
                };
                options = {
                    responsive: true,
                    plugins:{
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: timeTick
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Pressure'
                            },
                            // min: 10,
                            // max: 45,
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + " hPa";
                                },
                                stepSize: 100
                            }
                        }
                    }
                }
                config = {
                    type: 'line',
                    data: data,
                    options: options,
                };
                const pressureChart= new Chart(ctx, config);

                // CO2
                const CO2Data = parsedData.map(sensorData => sensorData["CO2_SCD40"]);

                ctx = document.getElementById('CO2Chart');
                ctx2d = ctx.getContext("2d");
                data = {
                    labels: labels,
                    datasets: [{
                        label: 'Dataset',
                        data: CO2Data,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                };
                options = {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: timeTick
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'CO2'
                            },
                            // min: 10,
                            // max: 45,
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + " ppm";
                                },
                                stepSize: 100
                            }
                        }
                    }
                }
                config = {
                    type: 'line',
                    data: data,
                    options: options,
                };
                const CO2Chart = new Chart(ctx, config);

                // Gas Resistance
                const gasResistanceBME688Data = parsedData.map(sensorData => sensorData["gas_resistance_bme688"]);

                ctx = document.getElementById('GasChart');
                ctx2d = ctx.getContext("2d");
                data = {
                    labels: labels,
                    datasets: [{
                        label: 'BME688 Gas Resistance',
                        data: gasResistanceBME688Data,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                };
                options = {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: timeTick
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Gas Resistance'
                            },
                            // min: 10,
                            // max: 45,
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + " ohms";
                                },
                                stepSize: 10
                            }
                        }
                    }
                }
                config = {
                    type: 'line',
                    data: data,
                    options: options,
                };
                const gasChart = new Chart(ctx, config);

                // TVOC
                const TVOCData = parsedData.map(sensorData => sensorData["TVOC_sgp30"]);

                ctx = document.getElementById('TVOCChart');
                ctx2d = ctx.getContext("2d");
                data = {
                    labels: labels,
                    datasets: [{
                        label: 'Dataset',
                        data: TVOCData,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                };
                options = {
                    responsive: true,
                    plugins:{
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: timeTick
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Volatile Organic Compounds'
                            },
                            // min: 10,
                            // max: 45,
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + " ppb";
                                },
                                stepSize: 2
                            }
                        }
                    }
                }
                config = {
                    type: 'line',
                    data: data,
                    options: options,
                };
                const TVOCChart= new Chart(ctx, config);
                
                // eCO2
                const eCO2Data = parsedData.map(sensorData => sensorData["eCO2_sgp30"]);

                ctx = document.getElementById('eCO2Chart');
                ctx2d = ctx.getContext("2d");
                data = {
                    labels: labels,
                    datasets: [{
                        label: 'Dataset',
                        data: eCO2Data,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                };
                options = {
                    responsive: true,
                    plugins:{
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: timeTick
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Equivalent CO2'
                            },
                            // min: 10,
                            // max: 45,
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + " ppm";
                                },
                                stepSize: 100
                            }
                        }
                    }
                }
                config = {
                    type: 'line',
                    data: data,
                    options: options,
                };
                const eCO2Chart= new Chart(ctx, config);

                const visibleLuminosityTSL2591 = parsedData.map(sensorData => sensorData["visible_luminosity_tsl2591"]);
                const infrafredLuminosityTSL2591 = parsedData.map(sensorData => sensorData["infrared_luminosity_tsl2591"]);
                const luxTSL2591 = parsedData.map(sensorData => sensorData["lux_tsl2591"]);

                ctx = document.getElementById('luxChart');
                ctx2d = ctx.getContext("2d");
                data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'LuxDataset',
                            data: luxTSL2591,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'VisibleLuminosityDataset',
                            data: visibleLuminosityTSL2591,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },
                        {
                            label: 'InfraredLuminosityDataset',
                            data: infrafredLuminosityTSL2591,
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        },

                    ]
                };
                options = {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: timeTick
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Lux'
                            },
                            // min: 10,
                            // max: 45,
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return value + " lux";
                                },
                                stepSize: 100
                            }
                        }
                    }
                }
                config = {
                    type: 'line',
                    data: data,
                    options: options,
                };
                const luxChart = new Chart(ctx, config);

            } catch (e) {
                console.error(e)
                // Deal with the fact the chain failed
            }
            // `text` is not available here
        })();


    </script>
</body>

</html>